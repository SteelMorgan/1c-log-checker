# Настройка переопределения пути к logcfg.xml

Это руководство описывает, как настроить 1С:Предприятие для чтения файла `logcfg.xml` из каталога проекта вместо системной директории.

## Зачем это нужно?

По умолчанию 1С:Предприятие ищет файл `logcfg.xml` в системной директории:
- **Windows:** `C:\Program Files\1cv8\conf\logcfg.xml`
- **Linux:** `~/.1cv8/conf/logcfg.xml`

Однако, для работы с Docker-контейнерами и MCP сервером удобнее хранить файл конфигурации в каталоге проекта, где:
- Не требуются права администратора для записи
- Файл доступен для Docker volume mount
- Легче управлять версиями через Git

## Схема работы

```
┌─────────────────────────────────────────────────────────────┐
│ 1C Platform (на хосте)                                      │
│                                                              │
│  Читает: C:\Program Files\1cv8\8.3.27.1719\bin\conf\conf.cfg│
│  └─> ConfLocation указывает каталог: configs/techlog/     │
│  └─> Ищет logcfg.xml в указанном каталоге                  │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ Проект: configs/techlog/                                     │
│                                                              │
│  logcfg.xml  ← Создается/обновляется MCP сервером          │
│  conf.cfg.template  ← Шаблон для копирования               │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ Docker Container: /app/techlog-config/                     │
│                                                              │
│  logcfg.xml  ← Монтируется из configs/techlog/              │
└─────────────────────────────────────────────────────────────┘
```

## Шаги настройки

### 1. Настройка переменной окружения

В файле `deploy/docker/.env` (скопируйте из `deploy/docker/.env.example` если нужно) укажите путь к каталогу проекта:

```bash
# Windows
TECHLOG_CONFIG_DIR=configs/techlog

# Linux (абсолютный путь)
TECHLOG_CONFIG_DIR=/home/user/projects/1c-log-checker/configs/techlog
```

**Важно:** Используйте относительный путь от корня проекта для Windows, или абсолютный путь для Linux.

### 2. Создание файла conf.cfg в каталоге платформы

Файл `conf.cfg` определяет каталог, в котором 1С:Предприятие будет искать конфигурационные файлы (logcfg.xml и др.), если они не найдены по стандартным путям.

**Важно:** Файл `conf.cfg` хранится в нескольких местах. Первично он читается из каталога с платформой конкретной версии. В нем обычно указана переадресация в каталог `C:\Program Files\1cv8\conf\`, чтобы для всех версий использовались одни настройки. 

**Однако:** Переопределить каталог еще раз из директории `C:\Program Files\1cv8\conf\` **НЕ удаётся** (на 8.3.27 не сработало). Поэтому переопределяем в каталоге **каждой платформы**, которую используем.

#### Windows

1. Определите каталог платформы, которую используете. Например:
   ```
   C:\Program Files\1cv8\8.3.27.1719\bin\conf
   ```

2. Откройте PowerShell или командную строку **от имени администратора**

3. Отредактируйте файл `conf.cfg` в каталоге платформы:
   ```ini
   # Указываем тот же путь, что указали в файле deploy/docker/.env в параметре TECHLOG_CONFIG_DIR
   ConfLocation=D:\My Projects\FrameWork 1C\1c-log-checker\configs\techlog\
   ```
   
   **Важно:** 
   - Используйте **абсолютный путь к КАТАЛОГУ** (не к файлу logcfg.xml)
   - Путь должен совпадать с `TECHLOG_CONFIG_DIR` из файла `deploy/docker/.env` (но как абсолютный путь)
   - Можно использовать прямые слеши `/` или двойные обратные `\\`
   - Указывайте путь к каталогу, где будет находиться `logcfg.xml`
   - Файл `logcfg.xml` будет создан в `configs/techlog/logcfg.xml` на хосте

#### Linux

1. Определите каталог платформы, которую используете. Например:
   ```
   /opt/1cv8/x86_64/8.3.27.1719/conf
   ```

2. Отредактируйте файл `conf.cfg` в каталоге платформы:
   ```ini
   # Указываем тот же путь, что указали в файле deploy/docker/.env в параметре TECHLOG_CONFIG_DIR
   ConfLocation=/home/user/projects/1c-log-checker/configs/techlog
   ```

### 3. Проверка настройки

1. Убедитесь, что файл `conf.cfg` отредактирован в каталоге **конкретной версии платформы** (например, `C:\Program Files\1cv8\8.3.27.1719\bin\conf\conf.cfg`)
2. Проверьте, что параметр `ConfLocation` указывает на каталог проекта (тот же путь, что в `TECHLOG_CONFIG_DIR` из `deploy/docker/.env`, но как абсолютный путь)
3. Убедитесь, что каталог `configs/techlog/` существует в проекте
4. Запустите Docker контейнеры:
   ```bash
   cd deploy/docker
   docker-compose up -d
   ```

### 4. Использование MCP сервера

После настройки, MCP сервер будет создавать/обновлять файл `logcfg.xml` в каталоге проекта:

```bash
# Пример вызова через MCP
curl -X POST http://localhost:8080/tools/configure_techlog \
  -H "Content-Type: application/json" \
  -d '{
    "cluster_guid": "b0881663-f2a7-4195-b7a2-f7f8e6c3a8f3",
    "infobase_guid": "d723aefd-7992-420d-b5f9-a273fd4146be",
    "location": "D:/TechLogs/b0881663-f2a7-4195-b7a2-f7f8e6c3a8f3/d723aefd-7992-420d-b5f9-a273fd4146be",
    "config_path": "/app/techlog-config/logcfg.xml",
    "history": 24,
    "format": "json",
    "events": ["EXCP", "QERR"],
    "properties": ["all"]
  }'
```

Файл будет создан в `configs/techlog/logcfg.xml` на хосте, и 1С платформа будет читать его автоматически.

**Правила:**
- Одна строка = одна пара ключ=значение
- Комментарии начинаются с `#`
- Кодировка: UTF-8
- Путь должен быть **абсолютным** и указывать на **каталог** (не на файл)
- Параметр `ConfLocation` должен указывать на тот же каталог, что указан в переменной окружения `TECHLOG_CONFIG_DIR` (но как абсолютный путь)

**Важно:** 
- `ConfLocation` указывает каталог, где 1С будет искать `logcfg.xml`
- Сам файл `logcfg.xml` будет создан MCP сервером в этом каталоге (`configs/techlog/logcfg.xml`)
- Файл `conf.cfg` нужно редактировать в каталоге **конкретной версии платформы**, а не в `C:\Program Files\1cv8\conf\`
- Пример пути к файлу: `C:\Program Files\1cv8\8.3.27.1719\bin\conf\conf.cfg`

## Устранение проблем

### 1С не читает logcfg.xml из нового каталога

1. Проверьте, что файл `conf.cfg` отредактирован в каталоге **конкретной версии платформы** (например, `C:\Program Files\1cv8\8.3.27.1719\bin\conf\conf.cfg`)
2. Проверьте, что параметр `ConfLocation` указывает на **каталог** (не на файл)
3. Проверьте, что путь в `ConfLocation` совпадает с `TECHLOG_CONFIG_DIR` из `deploy/docker/.env` (но как абсолютный путь)
4. Проверьте права доступа к каталогу проекта
5. Перезапустите кластер 1С или дождитесь автоприменения (проверяется раз в минуту)

### Ошибка "permission denied" при создании файла

1. Убедитесь, что каталог `configs/techlog/` существует
2. Проверьте права на запись в каталог проекта
3. Проверьте, что Docker volume mount настроен правильно в `docker-compose.yml`

### Файл создается, но 1С его не видит

1. Убедитесь, что файл `conf.cfg` отредактирован в каталоге **конкретной версии платформы**, а не в `C:\Program Files\1cv8\conf\`
2. Проверьте путь в `conf.cfg` - параметр `ConfLocation` должен указывать на **каталог**, а не на файл
3. Убедитесь, что путь в `ConfLocation` совпадает с `TECHLOG_CONFIG_DIR` из `deploy/docker/.env` (но как абсолютный путь)
4. Убедитесь, что путь использует правильные разделители (`/` или `\\`)
5. Проверьте, что файл `logcfg.xml` действительно существует в указанном каталоге (`configs/techlog/logcfg.xml`)
6. Убедитесь, что путь абсолютный (не относительный)

## Дополнительная информация

- [Документация по logcfg.xml](./logcfg.md)
- [Использование MCP сервера](../mcp/usage.md)
- [TODO: Реализация techlog](../guides/TODO_techlog_implementation.md)

