# Исходный запрос пользователя

## Дата формирования
2025-11-13

## Цель проекта
Разработать сервис по парсингу логов журнала регистрации и технологического журнала 1С с последующей загрузкой в ClickHouse для визуализации в Grafana и предоставления данных AI-агентам через MCP.

## Контекст
- Сервис критичен для отладки и диагностики проблем в продуктивных системах 1С
- Объём технологического журнала может достигать **до 10 ГБ текстовых файлов в час**
- Требуется минимальная задержка (<1 секунды) между записью лога и его доступностью в системе
- Важно сохранять **все поля** технологического журнала без исключений

## Технические требования

### 1. Источники данных
**Журнал регистрации (.lgf/.lgp/.lgx):**
- Расположение серверных баз: `C:\Program Files\1cv8\srvinfo\reg_<port>\<cluster_guid>\<infobase_guid>\`
- Формат: последовательный `.lgf` (заголовок) + `.lgp` (фрагменты) + `.lgx` (индексы для серверного варианта)
- Файловые базы: каталог `1Cv8Log` в папке базы
- Идентификация: через GUID кластера и базы (связь GUID ↔ имя через `rac.exe` или служебные файлы)

**Технологический журнал:**
- Конфигурация через `logcfg.xml` (элемент `<log location="...">`)
- Форматы: text (иерархический/plain) и JSON
- Ротация: по времени или размеру
- Структура: каталоги зависят от `placement=folders|plain`
- События: динамический набор полей (PROC, SCOM, CONN, DBMSSQL, EXCP, TLOCK и др.)
- **Критично**: сохранять **все** свойства каждого события

### 2. Хранилище данных
**ClickHouse:**
- Таблицы: `event_log` (журнал регистрации), `tech_log` (технологический журнал), `log_offsets` (прогресс чтения)
- Retention: 30 дней по умолчанию (настраивается через `LOG_RETENTION_DAYS`)
- Партиционирование по дням для эффективного TTL
- Авторизация отключена (техническая база, локальная сеть)

### 3. Сервисы

**Go-парсер (log-parser):**
- Язык: **Go** (выбран из-за высокой производительности при больших объёмах)
- Архитектура: Clean Architecture, интерфейсы, DI
- Функции:
  - Чтение журнала регистрации (.lgf/.lgp/.lgx) с контролем дубликатов
  - Tail технологического журнала (text/json) с поддержкой ротации и zip
  - Батчевая запись в ClickHouse (<100 мс или <=500 записей)
  - Хранение offset (BoltDB на volume + опциональное зеркало в ClickHouse)
  - Polling <1 секунды
  - Graceful shutdown (SIGTERM)
  - Обработка повреждённых строк (пропуск + warn)
- Наблюдаемость: OpenTelemetry spans, JSON-логи с trace ID
- Режим `READ_ONLY`: для технической отладки, отключает запись в ClickHouse

**Go MCP-сервер (mcp-server):**
- Язык: **Go** (для единообразия стека и производительности)
- Протокол: MCP (stdio/http)
- Инструменты:
  - `get_event_log(cluster_guid, infobase_guid, mode, filters...)` — получение логов журнала регистрации
  - `get_tech_log(...)` — получение технологического журнала
  - `get_new_errors(...)` — новые ошибки за последние 24 часа
- Режимы вывода: `minimal` (по умолчанию, компактный JSON) / `full` (все поля)
- Маппинг GUIDов: `configs/cluster_map.yaml` для преобразования GUID → человекочитаемое имя

**Grafana:**
- Дашборды:
  - Общая активность (графики по уровням, базам)
  - Топ ошибок (таблица, группировка по event/user/metadata)
  - **Новые ошибки** (уникальные за последние сутки, автообновление 1 мин)
  - Техжурнал (длительные события, блокировки, запросы DBMSSQL)
- Auto-provision через `deploy/grafana/dashboards/`
- Datasource: ClickHouse (HTTP, без auth)

### 4. Конфигурация

**Переменные окружения (deploy/docker/.env):**
- `LOG_DIRS` — список каталогов журнала регистрации (через `;`)
- `TECHLOG_DIRS` — список каталогов технологического журнала (через `;`)
- `CLICKHOUSE_HOST`, `CLICKHOUSE_PORT`, `CLICKHOUSE_DB`
- `LOG_RETENTION_DAYS` — срок хранения (по умолчанию 30)
- `READ_ONLY` — технический режим (по умолчанию `false`)
- `OFFSET_MIRROR` — зеркалирование offset в ClickHouse (опционально)

**Файлы конфигурации:**
- `configs/cluster_map.yaml`:
  ```yaml
  clusters:
    "guid-xxx":
      name: "Prod Cluster"
      notes: "..."
  infobases:
    "guid-yyy":
      name: "ERP Production"
      cluster_guid: "guid-xxx"
      notes: "..."
  ```

### 5. Инфраструктура
- Docker Compose: все сервисы в контейнерах
- Volumes: `clickhouse_data`, `grafana_data`, `parser_offsets`, `parser_logs`
- Сети: `internal`, `monitoring`
- Windows paths примонтированы в контейнеры (read-only для логов)

## Принятые решения

1. **Стек парсера и MCP: Go** — для максимальной производительности при объёмах до 10 ГБ/час
2. **Offset storage: BoltDB + volume** — минимизация задержек, независимость от ClickHouse
3. **ClickHouse init: entrypoint-initdb.d** — стандартный механизм инициализации схемы
4. **Формат данных для агента: JSON** — компактный, структурированный, режимы minimal/full
5. **Retention: 30 дней** — настраиваемый через переменную окружения
6. **Авторизация ClickHouse: отключена** — технический сервис, закрытая сеть
7. **Методология: Kiro** — спека, чек-лист, итеративная разработка

## Ограничения и требования

- **Все поля технологического журнала** должны сохраняться (критично для диагностики)
- **Минимальная задержка** парсинга (<1 секунды)
- **Контроль дубликатов** записей журнала регистрации
- **Поддержка ротации** и сжатия (zip) технологического журнала
- **Graceful shutdown** с фиксацией offset
- **Обработка ошибок** без остановки сервиса (пропуск + логирование)
- **UTF-8 encoding** для всех файлов с русским текстом

## TODO (на будущее)

1. Поддержка чтения архивов `.lgd` (SQLite-формат журнала регистрации)
2. Поддержка XML-выгрузок журнала регистрации
3. MCP tool для настройки `logcfg.xml` (включение/отключение технологического журнала)
4. Внешняя обработка 1С для получения GUIDов кластера/базы (альтернатива `rac.exe`)
5. Расширенная аналитика Grafana (SLI, алерты)

## Источники

- Документация платформы 1С: `D:\My Projects\FrameWork 1C\scraping_its\out\v8327doc\`
- Шаблон MCP-сервера: `D:\My Projects\FrameWork 1C\Архив\1c-syntax-checker`
- Правила разработки Go: `D:\My Projects\FrameWork 1C\1c-log-checker\.cursor\rules\GO.MDC`
- Методология Kiro: `mcp_kiro-prompts`

## Метрики успеха

- Парсер обрабатывает 10 ГБ/час технологического журнала без потери данных
- Задержка от записи в лог до доступности в ClickHouse <1 секунды
- Все поля технологического журнала сохранены
- MCP-агент получает данные в удобном формате (minimal/full)
- Grafana отображает новые ошибки в реальном времени
- Система работает стабильно 24/7 без ручного вмешательства

