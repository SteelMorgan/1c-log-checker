# MCP Tools: Руководство по использованию

Этот документ описывает использование MCP-инструментов для работы с логами 1С.

---

## Обзор

MCP-сервер предоставляет инструменты для работы с технологическим журналом:

### Чтение логов:
1. `get_event_log` — получение журнала регистрации
2. `get_tech_log` — получение технологического журнала
3. `get_new_errors` — новые ошибки за период
4. `get_actual_log_timestamp` — максимальная отметка времени в логах для базы

### Управление конфигурацией техжурнала:
5. `save_techlog` — сохранение текущей конфигурации как backup (.OLD)
6. `configure_techlog` — создание новой конфигурации logcfg.xml
7. `get_techlog_config` — чтение текущей конфигурации
8. `restore_techlog` — восстановление конфигурации из backup (.OLD)
9. `disable_techlog` — отключение техжурнала

### Процесс работы с техжурналом:

**Типичный workflow:**
1. `save_techlog` — сохранить текущую конфигурацию (если есть)
2. `configure_techlog` — создать новую конфигурацию
3. `get_tech_log` — читать логи из ClickHouse
4. `restore_techlog` — восстановить старую конфигурацию (если нужно)
5. `disable_techlog` — отключить логирование после завершения диагностики

**Важно:** Агент не работает с файлами напрямую. Все операции с файлами (создание, переименование, удаление) выполняет MCP-сервер. Агент только предоставляет строку конфигурации для `configure_techlog`.

---

## 1. get_event_log

Получение записей журнала регистрации.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `cluster_guid` | string | Да | GUID кластера |
| `infobase_guid` | string | Да | GUID информационной базы |
| `from` | datetime | Да | Начало периода |
| `to` | datetime | Да | Конец периода |
| `level` | string | Нет | Фильтр по уровню (Error, Warning, Information, Note) |
| `mode` | string | Нет | Режим вывода: `minimal` (по умолчанию) или `full` |
| `limit` | int | Нет | Макс. количество записей (по умолчанию 1000) |

### Режимы вывода:

**minimal** (экономия токенов):
```json
{
  "event_time": "2025-11-13T14:42:28",
  "level": "Information",
  "event_presentation": "Данные. Изменение",
  "user_name": "OrpovaE",
  "comment": "",
  "metadata_presentation": "Документ. Коммерческое предложение клиенту"
}
```

**full** (все поля):
```json
{
  "event_time": "2025-11-13T14:42:28",
  "cluster_guid": "...",
  "cluster_name": "Production",
  "level": "Information",
  "event": "_$InfoBase$_.Update",
  "event_presentation": "Данные. Изменение",
  "user_name": "OrpovaE",
  "user_id": "00000000-0000-0000-0000-000000000001",
  "computer": "DC-RDS-DEV1C",
  "session_id": 26,
  "transaction_id": "13.11.2025 14:42:35 (3779062)",
  "transaction_status": "Зафиксирована",
  "metadata_presentation": "Документ. Коммерческое предложение клиенту",
  "data_presentation": "Коммерческое предложение клиенту ДП-00108062",
  "server": "msk-srv-1c-08",
  ...
}
```

### Примеры использования:

**Запрос последних ошибок:**
```
User: Покажи последние ошибки за последний час

Agent вызывает:
get_event_log(
  cluster_guid="<guid>",
  infobase_guid="<guid>",
  from=now()-1h,
  to=now(),
  level="Error",
  mode="minimal"
)
```

**Анализ действий пользователя:**
```
User: Что делал пользователь OrpovaE сегодня в 14:42?

Agent вызывает:
get_event_log(
  cluster_guid="<guid>",
  infobase_guid="<guid>",
  from="2025-11-13T14:40:00",
  to="2025-11-13T14:45:00",
  mode="full"  // Нужны детали для анализа
)

Затем фильтрует по user_name="OrpovaE"
```

---

## 2. get_tech_log

Получение записей технологического журнала.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `cluster_guid` | string | Да | GUID кластера |
| `infobase_guid` | string | Да | GUID информационной базы |
| `from` | datetime | Да | Начало периода |
| `to` | datetime | Да | Конец периода |
| `name` | string | Нет | Фильтр по типу события (EXCP, DBMSSQL, TLOCK, etc.) |
| `mode` | string | Нет | Режим: `minimal` или `full` |
| `limit` | int | Нет | Макс. записей (по умолчанию 1000) |

### Типы событий (name):

**Критичные:**
- `EXCP` — исключительные ситуации (ошибки)
- `QERR` — ошибки компиляции запросов

**Производительность:**
- `DBMSSQL`, `DBPOSTGRS`, `DBORACLE` — SQL-запросы к СУБД
- `SDBL` — запросы к модели данных 1С

**Блокировки:**
- `TLOCK` — управление блокировками
- `TTIMEOUT` — превышение времени ожидания
- `TDEADLOCK` — взаимоблокировка

**Соединения:**
- `CONN` — соединения клиентов
- `SESN` — сеансы пользователей

### Примеры:

**Поиск исключений:**
```
User: Покажи все исключения за последние 30 минут

Agent:
get_tech_log(
  cluster_guid="<guid>",
  infobase_guid="<guid>",
  from=now()-30m,
  to=now(),
  name="EXCP",
  mode="full"
)
```

**Анализ медленных запросов:**
```
User: Найди медленные SQL-запросы (>5 сек)

Agent:
get_tech_log(
  cluster_guid="<guid>",
  infobase_guid="<guid>",
  from=now()-1h,
  to=now(),
  name="DBMSSQL",
  mode="full"
)

Затем фильтрует по duration > 5000000 микросекунд
```

---

## 3. get_new_errors

Получение ошибок, появившихся впервые за последние N часов.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `cluster_guid` | string | Да | GUID кластера |
| `infobase_guid` | string | Да | GUID информационной базы |
| `limit` | int | Нет | Макс. ошибок (по умолчанию 100) |

### Пример:

```
User: Какие новые ошибки появились сегодня?

Agent:
get_new_errors(
  cluster_guid="<guid>",
  infobase_guid="<guid>",
  limit=50
)

Ответ:
{
  "event_name": "EXCP",
  "error_text": "Ошибка при выполнении запроса к базе данных",
  "occurrences": 5,
  "first_seen": "2025-11-13T14:30:00",
  "last_seen": "2025-11-13T15:00:00"
}
```

---

## 4. save_techlog

Сохранение текущей конфигурации технологического журнала как backup.

**Назначение:** Сохраняет текущий `logcfg.xml` как `logcfg.xml.OLD` перед созданием новой конфигурации. Это позволяет восстановить предыдущую конфигурацию при необходимости.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `config_path` | string | Нет | Путь к logcfg.xml (если не указан, используется путь из конфигурации) |

### Поведение:

- Если `logcfg.xml` существует → копируется в `logcfg.xml.OLD` (перезаписывает существующий .OLD, если есть)
- Если `logcfg.xml` не существует → возвращает ошибку "config file not found"

### Пример:

```
User: Сохрани текущую конфигурацию техжурнала

Agent:
save_techlog(
  config_path="configs/techlog/logcfg.xml"
)

Результат: logcfg.xml скопирован в logcfg.xml.OLD
```

---

## 5. configure_techlog

Создание новой конфигурации технологического журнала.

**Назначение:** Генерирует XML-конфигурацию `logcfg.xml` и сохраняет её в указанный путь. Валидирует структуру пути, если указаны `cluster_guid` и `infobase_guid`.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `cluster_guid` | string | Да* | GUID кластера (обязателен для валидации пути) |
| `infobase_guid` | string | Да* | GUID информационной базы (обязателен для валидации пути) |
| `location` | string | Да | Путь к каталогу для логов (должен содержать cluster_guid/infobase_guid в структуре) |
| `history` | int | Да | Время хранения (часы) |
| `format` | string | Нет | Формат: `text` (по умолчанию) или `json` |
| `events` | array | Да | Список событий для логирования |
| `properties` | array | Нет | Список свойств (по умолчанию `["all"]`) |
| `config_path` | string | Нет | Путь для сохранения logcfg.xml (если не указан, используется путь из конфигурации) |

\* `cluster_guid` и `infobase_guid` обязательны для валидации структуры пути `location`. Путь должен начинаться с одного из `TECHLOG_DIRS` и содержать эти GUID в структуре каталогов.

### Примеры:

**Конфигурация для отлова ошибок:**
```
User: Настрой техжурнал для записи всех ошибок в D:\1CLogs\Errors

Agent:
configure_techlog(
  location="D:\\1CLogs\\Errors",
  history=120,
  events=["EXCP", "QERR", "EXCPCNTX"],
  properties=["all"]
)

Результат: XML-конфигурация logcfg.xml
```

**Конфигурация для анализа производительности:**
```
User: Нужно логировать медленные SQL-запросы (>1 сек)

Agent:
configure_techlog(
  location="D:\\1CLogs\\Performance",
  history=24,
  format="json",
  events=["DBMSSQL", "SDBL"],
  properties=["sql", "planSQLText", "duration"]
)
```

**Полная конфигурация для диагностики блокировок:**
```
User: Включи логи для расследования блокировок

Agent:
configure_techlog(
  location="D:\\1CLogs\\Locks",
  history=48,
  events=["TLOCK", "TTIMEOUT", "TDEADLOCK", "CONN", "SESN"],
  properties=["all"]
)
```

---

## 6. get_techlog_config

Чтение текущей конфигурации технологического журнала.

**Назначение:** Возвращает содержимое текущего файла `logcfg.xml` в виде XML-строки.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `config_path` | string | Нет | Путь к logcfg.xml (если не указан, используется путь из конфигурации) |

### Пример:

```
User: Какая сейчас настройка техжурнала?

Agent:
get_techlog_config(
  config_path="configs/techlog/logcfg.xml"
)

Результат: XML-содержимое logcfg.xml
```

---

## 7. restore_techlog

Восстановление конфигурации технологического журнала из backup.

**Назначение:** Восстанавливает предыдущую конфигурацию из `logcfg.xml.OLD`. Удаляет текущий `logcfg.xml` и переименовывает `.OLD` файл обратно в `.xml`.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `config_path` | string | Нет | Путь к logcfg.xml (если не указан, используется путь из конфигурации) |

### Поведение:

1. Проверяет наличие `logcfg.xml.OLD`
2. Если `.OLD` существует:
   - Удаляет текущий `logcfg.xml` (если существует)
   - Переименовывает `logcfg.xml.OLD` в `logcfg.xml`
3. Если `.OLD` не существует → возвращает ошибку "backup file not found"

### Пример:

```
User: Восстанови предыдущую конфигурацию техжурнала

Agent:
restore_techlog(
  config_path="configs/techlog/logcfg.xml"
)

Результат: logcfg.xml восстановлен из logcfg.xml.OLD
```

---

## 8. disable_techlog

Отключение технологического журнала.

**Назначение:** Отключает логирование, создавая пустую конфигурацию без элементов `<log>`.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `config_path` | string | Нет | Путь к logcfg.xml (если не указан, используется путь из конфигурации) |

### Поведение:

- Создает минимальную конфигурацию без элементов `<log>` (логирование отключено)
- Если файл не существует → возвращает успех (уже отключено)

### Пример:

```
User: Отключи техжурнал, проблема найдена

Agent:
disable_techlog(
  config_path="configs/techlog/logcfg.xml"
)

Результат: logcfg.xml содержит пустую конфигурацию (логирование отключено)
```

---

## 9. get_actual_log_timestamp

Получение максимальной отметки времени в технологическом журнале для указанной базы данных.

**Назначение:** Возвращает максимальный timestamp (последнюю обработанную запись) из таблицы `logs.tech_log` для указанной информационной базы. Полезно для проверки, до какого времени уже обработаны логи в ClickHouse.

### Параметры:

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `base_id` | string | Да | GUID информационной базы (infobase_guid) |

### Возвращаемые данные:

```json
{
  "base_id": "d723aefd-7992-420d-b5f9-a273fd4146be",
  "max_timestamp": "2025-11-15T14:23:45.123456Z",
  "has_data": true
}
```

Если записей нет:
```json
{
  "base_id": "d723aefd-7992-420d-b5f9-a273fd4146be",
  "max_timestamp": null,
  "has_data": false
}
```

### Примеры использования:

**Проверка актуальности данных:**
```
User: До какого времени обработаны логи для базы d723aefd-7992-420d-b5f9-a273fd4146be?

Agent:
get_actual_log_timestamp(
  base_id="d723aefd-7992-420d-b5f9-a273fd4146be"
)

Результат: Максимальный timestamp в ClickHouse
```

**Использование для определения временного окна:**
```
User: Покажи логи за последний час для базы

Agent:
1. get_actual_log_timestamp(base_id="...")
   // Получаем max_timestamp = "2025-11-15T14:23:45Z"
   
2. get_tech_log(
     from="2025-11-15T13:23:45Z",  // max_timestamp - 1 hour
     to="2025-11-15T14:23:45Z",    // max_timestamp
     ...
   )
```

---

## Советы по минимизации токенов

### Используйте режим minimal по умолчанию

Minimal режим экономит ~60-70% токенов, возвращая только критичные поля.

### Фильтруйте данные на стороне агента

Вместо:
```
get_event_log(from=now()-7d, limit=10000) // Получить всё за неделю
```

Лучше:
```
get_event_log(from=now()-1h, level="Error", limit=100) // Только ошибки за час
```

### Используйте временные окна разумно

- Для быстрой диагностики: 15-30 минут
- Для анализа трендов: 1-6 часов
- Для расследования: 24 часа max

### Комбинируйте инструменты

1. Сначала `get_new_errors` — узнать, что случилось
2. Затем `get_event_log` с фильтром — детали по конкретной ошибке
3. Затем `get_tech_log` — техническая информация (SQL, блокировки)

---

## Примеры сценариев использования

### Сценарий 1: Расследование ошибки пользователя

```
User: Пользователь OrpovaE жалуется на ошибку при сохранении документа в 14:42

Agent (последовательность):
1. get_event_log(
     from="2025-11-13T14:40:00",
     to="2025-11-13T14:45:00",
     level="Error",
     mode="minimal"
   )
   
2. Если нашли ошибку → повторный запрос с mode="full" для деталей

3. get_tech_log(
     from="2025-11-13T14:42:00",
     to="2025-11-13T14:43:00",
     name="EXCP",
     mode="full"
   )
   
Результат: Полная картина ошибки с техническими деталями
```

### Сценарий 2: Анализ блокировок

```
User: Почему тормозит проведение документов?

Agent:
1. get_tech_log(
     from=now()-15m,
     name="TTIMEOUT",  // Превышения времени ожидания
     mode="full"
   )
   
2. get_tech_log(
     from=now()-15m,
     name="TLOCK",  // Блокировки
     mode="full"
   )
   
Анализ свойств lka/lkp/lkaid/lkpid для определения источника блокировки
```

### Сценарий 3: Настройка техжурнала для отладки

```
User: Нужно включить детальное логирование для отладки медленных запросов

Agent (последовательность):
1. save_techlog(
     config_path="configs/techlog/logcfg.xml"
   )
   // Сохраняет текущую конфигурацию как backup

2. configure_techlog(
     cluster_guid="<guid>",
     infobase_guid="<guid>",
     location="D:\\1CLogs\\Debug\\<cluster_guid>\\<infobase_guid>",
     history=12,  // 12 часов
     format="json",  // Удобнее парсить
     events=["DBMSSQL", "SDBL", "EXCP"],
     properties=["sql", "planSQLText", "duration", "Rows"]
   )
   // Создает новую конфигурацию

3. get_tech_log(...) // Читает логи из ClickHouse

4. После отладки:
   disable_techlog(config_path="configs/techlog/logcfg.xml")
   // Или restore_techlog() для восстановления предыдущей конфигурации
```

---

## Ограничения

- **Максимум записей за запрос:** 10,000 (настраивается через limit)
- **Минимальная гранулярность времени:** 1 секунда
- **Размер ответа:** рекомендуется <100 KB (зависит от режима и количества записей)

---

## Troubleshooting

### Пустой результат

**Проблема:** get_event_log возвращает пустой массив.

**Решения:**
1. Проверьте правильность GUID (используйте get_new_errors для проверки)
2. Расширьте временное окно
3. Проверьте фильтр level (может быть слишком строгий)

### Слишком много данных

**Проблема:** Ответ слишком большой, превышает лимит токенов.

**Решения:**
1. Используйте mode="minimal"
2. Уменьшите временное окно
3. Добавьте фильтры (level, name)
4. Снизьте limit

### GUID не распознаётся

**Проблема:** cluster_name/infobase_name возвращают GUID вместо имени.

**Решение:** Добавьте GUID в `cluster_map.yaml` в корне проекта (образец в `configs/cluster_map.yaml`, см. docs/guides/get-guids.md)

---

## Best Practices для AI-агентов

1. **Начинайте с minimal mode** — переходите к full только при необходимости
2. **Используйте короткие временные окна** — расширяйте по необходимости
3. **Комбинируйте инструменты** — сначала get_new_errors, затем детали
4. **Фильтруйте на стороне ClickHouse** — используйте параметры level/name вместо постфильтрации
5. **Сохраняйте контекст сеанса** — используйте session_id/transaction_id для связи событий

---

**Дополнительная информация:**
- [Получение GUIDов](../guides/get-guids.md)
- [Настройка logcfg.xml](../techlog/logcfg.md)
- [Спецификация](../specs/log-service.spec.md)

