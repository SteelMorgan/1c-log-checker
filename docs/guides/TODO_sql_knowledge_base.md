# TODO: База знаний "MS SQL Server и PostgreSQL в контексте 1С"

**Статус:** Запланировано  
**Приоритет:** Высокий  
**Цель:** Создать индекс знаний для расследования блокировок и проблем производительности

---

## Структура базы знаний

### 1. Типы блокировок в 1С

#### Управляемые блокировки
- S-блокировки (Shared) — разделяемые
- X-блокировки (Exclusive) — исключительные
- Разница в 8.2 и 8.3:
  - 8.2: блокировка на уровне записи при любых операциях
  - 8.3: блокировка только на уровне записи (улучшенная производительность)
- Исключение: Справочник.НайтиПоНаименованию() — блокирует всю таблицу даже в 8.3

#### Транзакционные блокировки
- Автоматические блокировки СУБД
- Зависят от режима изоляции транзакций
- Могут приводить к взаимоблокировкам (deadlocks)

### 2. MS SQL Server: Read Committed Snapshot Isolation (RCSI)

#### Что такое RCSI?
**Must Have** для работы 1С с MS SQL Server!

- Режим изоляции транзакций, устраняющий блокировки при чтении
- Операции SELECT не блокируют UPDATE/INSERT/DELETE
- Используется версионирование строк (row versioning)
- Резко снижает количество блокировок

#### Как включить RCSI:

```sql
ALTER DATABASE [database_name] 
SET READ_COMMITTED_SNAPSHOT ON WITH ROLLBACK IMMEDIATE;
```

**Важно:** При включении RCSI база блокируется на время переключения!

#### Влияние на производительность:
- ✅ Меньше блокировок → быстрее работа
- ✅ Читающие транзакции не ждут записывающих
- ⚠️ Увеличивается размер tempdb (для версионирования)
- ⚠️ Требуется SSD для tempdb (критично!)

### 3. Взаимоблокировки (Deadlocks)

#### Причины возникновения:
- Два или более процессов ждут ресурсы друг друга
- Обращение к одним и тем же ресурсам в разном порядке
- Длительные транзакции с множественными операциями

#### Как выявить:
- События технологического журнала: **TDEADLOCK**
- Свойства **lka/lkp** (источник/жертва блокировки)
- SQL Server Profiler (событие Deadlock Graph)

#### Как предотвратить:
- Сокращать время транзакций
- Обращаться к объектам в одном порядке
- Использовать управляемые блокировки 1С
- Включить RCSI для MS SQL

### 4. Анализ блокировок через технологический журнал

#### События для мониторинга:
```xml
<event>
    <eq property="name" value="tlock"/>
</event>
<event>
    <eq property="name" value="ttimeout"/>
</event>
<event>
    <eq property="name" value="tdeadlock"/>
</event>
```

#### Свойства блокировок:
- `lka='1'` — поток является источником блокировки
- `lkp='1'` — поток является жертвой блокировки
- `lkpid` — номер запроса к СУБД (жертва)
- `lkaid` — список номеров запросов (источник)
- `lksrc` — номер соединения источника
- `lkpto` — время ожидания (секунды)
- `lkato` — время блокировки (секунды)

#### Методика расследования:
1. Найти события с `lka` и `lkp`
2. Извлечь `lkaid` и `lkpid`
3. Найти все события с этими ID во всех процессах кластера
4. Определить, кто кого заблокировал и почему

### 5. Оптимизация запросов

#### События для анализа:
- **DBMSSQL** — все SQL-запросы к MS SQL
- **SDBL** — запросы к модели данных 1С
- Фильтр по `duration` (>1000000 микросекунд = >1 секунда)

#### Свойства для анализа:
- `sql` — текст запроса
- `planSQLText` — план выполнения
- `Rows` — количество обработанных строк
- `duration` — время выполнения

#### Типичные проблемы:
- Отсутствие индексов
- Чтение больших объёмов данных без фильтрации
- Вложенные циклы в запросах
- Неоптимальные JOIN

### 6. Инструменты диагностики

#### Внешняя обработка "Монитор производительности MS SQL Server в 1С"
Источник: https://infostart.ru/public/557477/

Возможности:
- Просмотр активных блокировок в реальном времени
- Идентификация источника и жертвы
- Анализ времени ожидания
- SQL-запросы, вызывающие блокировки

#### Технологический журнал (встроенный):
- Элемент `<dbmslocks/>` — сбор информации о блокировках СУБД
- Элемент `<plansql/>` — сбор планов выполнения запросов

### 7. Best Practices

#### Общие рекомендации:
1. ✅ **Включить RCSI для MS SQL** (критично!)
2. ✅ Минимизировать время транзакций
3. ✅ Избегать вложенных транзакций
4. ✅ Использовать управляемые блокировки где возможно
5. ✅ Разделять длительные операции на батчи (по 100-1000 записей)
6. ✅ Индексировать часто используемые поля

#### Что НЕ делать:
❌ Использовать Справочник.НайтиПоНаименованию() без режима управляемых блокировок  
❌ Оставлять открытые транзакции надолго  
❌ Выполнять SELECT COUNT(*) на больших таблицах без WHERE  
❌ Читать весь справочник в цикле без батчей  
❌ Использовать вложенные циклы с обращениями к БД  

#### MS SQL Server специфика:
- Разместить tempdb на быстром SSD
- Настроить количество файлов tempdb = количество ядер (max 8)
- Мониторить размер tempdb при включённом RCSI
- Регулярно обновлять статистику (UPDATE STATISTICS)

#### PostgreSQL специфика:
- Настроить shared_buffers (25% от RAM)
- Включить autovacuum
- Мониторить bloat таблиц
- Использовать connection pooling (PgBouncer)

### 8. Интеграция с сервисом парсинга логов

#### Как парсер поможет с блокировками:
1. Автоматический сбор событий TLOCK/TTIMEOUT/TDEADLOCK
2. Корреляция по `lkaid`/`lkpid` между разными процессами
3. Dashboard в Grafana для визуализации блокировок
4. MCP tool для запроса блокировок за период

#### Пример MCP-запроса:
```
User: Покажи все взаимоблокировки за последний час
Agent: [вызывает get_tech_log с фильтром name=TDEADLOCK]
Agent: Найдено 3 взаимоблокировки, источники: ...
```

---

## Источники

1. **Основная статья про блокировки (+455):**  
   https://infostart.ru/1c/articles/629017/

2. **Обработка "Монитор производительности MS SQL Server":**  
   https://infostart.ru/public/557477/

3. **Документация 1С:**
   - Управляемые блокировки
   - Транзакции
   - Технологический журнал (события TLOCK, TDEADLOCK)

4. **Дополнительные материалы:**
   - MS SQL Server RCSI documentation
   - PostgreSQL transaction isolation
   - Статьи на Infostart.ru по оптимизации производительности

---

**Этот файл будет использован для создания полноценного индекса знаний и, возможно, отдельного навыка (SKILL).**

