# TODO: Навык "Технологический журнал 1С"

**Статус:** Запланировано  
**Приоритет:** Высокий  
**Цель:** Создать skill-файл с полным описанием технологического журнала для AI-агентов

---

## Структура навыка

### 1. Введение
- Что такое технологический журнал
- Зачем нужен и когда использовать
- Расположение файла logcfg.xml

### 2. Структура logcfg.xml

#### Корневой элемент `<config>`
- Атрибуты xmlns
- Вложенные элементы

#### Элемент `<log>`
Атрибуты:
- `location` — путь к каталогу журнала
- `history` — время хранения (в часах)
- `format` — формат (text/json)
- `placement` — структура (folders/plain)
- `rotation` — ротация (period/size)
- `rotationperiod` — период ротации (часы)
- `rotationsize` — размер для ротации (МБ)
- `compress` — сжатие (none/zip)

#### Элемент `<event>`
Фильтры событий:
- `<eq property="name" value="..."/>` — равно
- `<ne property="name" value="..."/>` — не равно
- `<gt property="duration" value="..."/>` — больше
- `<ge>`, `<lt>`, `<le>` — другие операторы сравнения
- `<like property="..." value="..."/>` — по маске

#### Элемент `<property>`
- `<property name="all">` — все свойства
- `<property name="sql">` — только SQL-запросы
- Условия записи свойств

### 3. События технологического журнала (40+ типов)

#### Критичные события для диагностики ошибок:
- **EXCP** — исключительные ситуации (аварийное завершение)
- **EXCPCNTX** — контекст исключения (события, незавершённые на момент ошибки)
- **QERR** — ошибки компиляции запросов

#### События производительности:
- **DBMSSQL** — SQL-запросы к MS SQL Server
- **DBPOSTGRS** — SQL-запросы к PostgreSQL
- **DBORACLE** — SQL-запросы к Oracle
- **DB2** — SQL-запросы к DB2
- **DBV8DBENG** — запросы к файловой СУБД
- **SDBL** — запросы к модели данных 1С

#### События блокировок:
- **TLOCK** — управление транзакционными блокировками
- **TTIMEOUT** — превышение времени ожидания блокировки
- **TDEADLOCK** — обнаружена взаимоблокировка

#### События соединений и сеансов:
- **CONN** — установка/разрыв соединения
- **SESN** — начало/окончание сеанса
- **PROC** — события процесса (старт, завершение, аварийное завершение)
- **SCOM** — создание/удаление серверного контекста

#### События вызовов:
- **CALL** — входящий удалённый вызов
- **SCALL** — исходящий удалённый вызов

#### Системные события:
- **ADMIN** — административные действия
- **CLSTR** — операции кластера серверов
- **SRVC** — запуск/остановка сервисов

#### Специализированные:
- **MEM** — события увеличения памяти
- **LEAKS** — утечки памяти
- **HASP** — работа с аппаратным ключом
- **LIC** — события лицензирования
- **FTEXTUPD** — обновление полнотекстового поиска
- **FTS** — события полнотекстового поиска v2

Полный список (40+ событий) см. в документации платформы.

### 4. Примеры конфигураций

#### Минимальная конфигурация (только ошибки):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<config xmlns="http://v8.1c.ru/v8/tech-log">
    <dump create="false"/>
    <log location="D:\1CLogs\Errors\" history="120">
        <event>
            <eq property="name" value="excp"/>
        </event>
        <event>
            <eq property="name" value="qerr"/>
        </event>
        <property name="all"/>
    </log>
</config>
```

#### Конфигурация для анализа блокировок:
```xml
<config xmlns="http://v8.1c.ru/v8/tech-log">
    <log location="D:\1CLogs\Locks\" history="24">
        <event>
            <eq property="name" value="tlock"/>
        </event>
        <event>
            <eq property="name" value="ttimeout"/>
        </event>
        <event>
            <eq property="name" value="tdeadlock"/>
        </event>
        <event>
            <eq property="name" value="conn"/>
        </event>
        <property name="all"/>
    </log>
    <dbmslocks/>
</config>
```

#### Конфигурация для анализа производительности:
```xml
<config xmlns="http://v8.1c.ru/v8/tech-log">
    <log location="D:\1CLogs\Performance\" history="12">
        <event>
            <eq property="name" value="dbmssql"/>
            <gt property="duration" value="1000000"/>  <!-- >1 sec -->
        </event>
        <event>
            <eq property="name" value="sdbl"/>
            <gt property="duration" value="500000"/>  <!-- >0.5 sec -->
        </event>
        <property name="sql"/>
        <property name="planSQLText"/>
    </log>
    <plansql/>
</config>
```

### 5. Best Practices (из Infostart.ru)

#### Рекомендации по настройке:
1. **Не включать все события сразу** — это сильно замедляет систему
2. **Использовать фильтры duration** для отбора только медленных операций
3. **Ограничивать history** (не более 24-48 часов для production)
4. **Использовать rotation и compress** для экономии места
5. **Не более 20 элементов `<log>`** в одном конфигурационном файле

#### Критичные события (всегда включать):
- EXCP, EXCPCNTX — для диагностики ошибок
- PROC, CONN — базовая информация о процессах

#### События с высокой нагрузкой (включать с осторожностью):
- DBMSSQL, DBPOSTGRS, DBORACLE, SDBL — генерируют большой объём данных
- Использовать фильтры по duration (>1 сек, >5 сек)

#### Рекомендации по расположению:
- Отдельные диски для логов (не системный)
- SSD предпочтительнее HDD
- Мониторинг свободного места

### 6. Свойства событий

#### Общие свойства:
- `name` — имя события
- `level` — уровень (INFO, WARN, ERROR)
- `process` — имя процесса
- `OSThread` — ID потока ОС
- `duration` — длительность (микросекунды)
- `ClientID` — ID клиента
- `SessionID` — ID сеанса
- `Usr` — пользователь
- `AppID` — ID приложения
- `ConnID` — ID соединения

#### Специфичные для DBMSSQL/DBPOSTGRS:
- `sql` — текст SQL-запроса
- `planSQLText` — план выполнения запроса
- `Rows` — количество строк
- `RowsAffected` — затронуто строк

#### Специфичные для TLOCK:
- `lka` — поток является источником блокировки
- `lkp` — поток является жертвой блокировки
- `lkpid` — номер запроса жертвы
- `lkaid` — номера запросов источника
- `lksrc` — номер соединения источника
- `lkpto` — время ожидания жертвы
- `lkato` — время блокировки источником

### 7. Форматы файлов

#### Text формат (иерархический, placement=folders):
```
45:31.831006-1,SCALL,2,level=INFO,process=1cv8,OSThread=13476,...
```

Формат: `mm:ss.microsec-duration,EVENT,depth,properties...`

#### Text формат (plain, placement=plain):
```
2023-08-01T15:01:45.259000-14998,SCALL,0,level=INFO,...
```

Формат: `YYYY-MM-DDThh:mm:ss.microsec-duration,EVENT,depth,properties...`

#### JSON формат:
```json
{"ts":"2023-08-02T08:48:05.982000","duration":"46998","name":"SCALL","level":"INFO",...}
```

### 8. Anti-patterns (что НЕ делать)

❌ Включать все события без фильтров  
❌ Устанавливать history > 48 часов в production  
❌ Записывать DBMSSQL без фильтра по duration  
❌ Забывать про rotation (переполнение диска)  
❌ Размещать логи на системном диске  
❌ Включать SYSTEM events без указания техподдержки  

### 9. Примеры использования в MCP

**Создание конфигурации через AI-агента:**
```
User: Настрой техжурнал для отлова ошибок и медленных запросов (>3 сек)
Agent: [вызывает configure_techlog с параметрами]
```

**Отключение техжурнала:**
```
User: Отключи техжурнал, проблема найдена
Agent: [вызывает disable_techlog]
```

---

## Источники

1. https://infostart.ru/1c/articles/1195695/ — детальная статья про техжурнал
2. Документация платформы (раздел 3.24 Приложения 3)
3. Комментарии экспертов на Infostart (с большим количеством плюсов)

---

**Этот файл будет преобразован в полноценный SKILL.md после сбора всей информации.**

