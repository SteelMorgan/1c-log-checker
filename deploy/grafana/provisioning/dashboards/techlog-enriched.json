{
  "title": "1C Tech Log - Errors (Enriched)",
  "uid": "1c-tech-log-errors-enriched",
  "version": 1,
  "schemaVersion": 38,
  "tags": ["1c", "tech-log", "errors", "enriched"],
  "timezone": "browser",
  "time": {
    "from": "now-24h",
    "to": "now"
  },
  "refresh": "5m",
  "templating": {
    "list": [
      {
        "name": "infobase",
        "type": "query",
        "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
        "query": "SELECT DISTINCT infobase_name FROM logs.tech_log WHERE infobase_name != '' ORDER BY infobase_name",
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "includeAll": true,
        "multi": true,
        "allValue": null
      },
      {
        "name": "event_name",
        "type": "query",
        "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
        "query": "SELECT DISTINCT name FROM logs.tech_log WHERE name != '' ORDER BY name",
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "includeAll": true,
        "multi": true,
        "allValue": null
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "title": "Tech Log Events Timeline",
      "type": "timeseries",
      "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  toDateTime(intDiv(toUInt32(timestamp), 300) * 300) AS time,\n  name AS event_type,\n  count() AS count\nFROM logs.tech_log\nWHERE $__timeFilter(timestamp)\n  AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n  AND ('$__all' IN ($event_name) OR name IN ($event_name))\nGROUP BY time, event_type\nORDER BY time",
          "format": 0
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 10
          },
          "color": {
            "mode": "palette-classic"
          }
        }
      }
    },
    {
      "id": 2,
      "title": "Errors Count by Event Type",
      "type": "barchart",
      "gridPos": {"h": 10, "w": 12, "x": 0, "y": 8},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  name AS \"Тип события\",\n  count() AS \"Количество\"\nFROM logs.tech_log\nWHERE $__timeFilter(timestamp)\n  AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n  AND name IN ('EXCP', 'ERR', 'EXCPTXT')  -- Error events only\nGROUP BY name\nORDER BY count() DESC",
          "format": 1
        }
      ],
      "options": {
        "orientation": "horizontal",
        "xField": "Количество",
        "colorByField": "Тип события"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "fixed",
            "fixedColor": "red"
          }
        }
      }
    },
    {
      "id": 3,
      "title": "All Events Count by Type",
      "type": "piechart",
      "gridPos": {"h": 10, "w": 12, "x": 12, "y": 8},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  name AS event,\n  count() AS count\nFROM logs.tech_log\nWHERE $__timeFilter(timestamp)\n  AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n  AND ('$__all' IN ($event_name) OR name IN ($event_name))\nGROUP BY event\nORDER BY count DESC\nLIMIT 20",
          "format": 1
        }
      ],
      "options": {
        "pieType": "donut",
        "tooltip": {
          "mode": "single"
        },
        "legend": {
          "displayMode": "table",
          "placement": "right",
          "values": ["value", "percent"]
        }
      }
    },
    {
      "id": 4,
      "title": "Errors by Metadata Type (Enriched)",
      "type": "table",
      "gridPos": {"h": 12, "w": 24, "x": 0, "y": 18},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "refId": "A",
          "queryType": "sql",
          "rawSql": "WITH metadata_errors AS (\n  SELECT\n    tl.timestamp,\n    tl.name,\n    tl.metadata_name,\n    tl.infobase_guid,\n    tl.infobase_name,\n    -- Extract GUID from metadata_name if it contains one\n    CASE\n      WHEN match(tl.metadata_name, '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}')\n      THEN reinterpretAsUUID(unhex(replaceAll(extractAll(tl.metadata_name, '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}')[1], '-', '')))\n      ELSE toUUID('00000000-0000-0000-0000-000000000000')\n    END AS metadata_guid\n  FROM logs.tech_log tl\n  WHERE $__timeFilter(timestamp)\n    AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n    AND name IN ('EXCP', 'ERR', 'EXCPTXT')\n    AND metadata_name != ''\n)\nSELECT\n  COALESCE(mm.metadata_name, me.metadata_name) AS \"Метаданные\",\n  COALESCE(mm.metadata_type, 'Unknown') AS \"Тип метаданных\",\n  count() AS \"Количество ошибок\",\n  min(me.timestamp) AS \"Первая ошибка\",\n  max(me.timestamp) AS \"Последняя ошибка\",\n  groupArray(DISTINCT me.name) AS \"Типы событий\",\n  groupArray(DISTINCT me.infobase_name) AS \"Информационные базы\"\nFROM metadata_errors me\nLEFT JOIN (\n  SELECT infobase_guid, metadata_guid, argMax(metadata_name, version) AS metadata_name, argMax(metadata_type, version) AS metadata_type\n  FROM logs.metadata_map\n  GROUP BY infobase_guid, metadata_guid\n) mm ON me.infobase_guid = mm.infobase_guid AND me.metadata_guid = mm.metadata_guid AND me.metadata_guid != toUUID('00000000-0000-0000-0000-000000000000')\nGROUP BY COALESCE(mm.metadata_name, me.metadata_name), COALESCE(mm.metadata_type, 'Unknown')\nORDER BY count() DESC\nLIMIT 50",
          "format": 1
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Количество ошибок"
          }
        ]
      }
    },
    {
      "id": 5,
      "title": "Top Exceptions with Details",
      "type": "table",
      "gridPos": {"h": 12, "w": 24, "x": 0, "y": 30},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  tl.timestamp AS \"Дата, время\",\n  tl.infobase_name AS \"Информационная база\",\n  tl.name AS \"Тип события\",\n  CASE\n    WHEN match(tl.metadata_name, '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}')\n    THEN COALESCE(\n      (\n        SELECT mm.metadata_name\n        FROM logs.metadata_map mm\n        WHERE mm.infobase_guid = tl.infobase_guid\n          AND mm.metadata_guid = reinterpretAsUUID(unhex(replaceAll(extractAll(tl.metadata_name, '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}')[1], '-', '')))\n        ORDER BY mm.version DESC\n        LIMIT 1\n      ),\n      tl.metadata_name\n    )\n    ELSE tl.metadata_name\n  END AS \"Метаданные\",\n  tl.error_description AS \"Описание ошибки\",\n  tl.server_computer_name AS \"Сервер\",\n  tl.application_name AS \"Приложение\",\n  tl.session_id AS \"ID сессии\",\n  tl.process_name AS \"Процесс\"\nFROM logs.tech_log tl\nWHERE $__timeFilter(timestamp)\n  AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n  AND name IN ('EXCP', 'ERR', 'EXCPTXT')\nORDER BY timestamp DESC\nLIMIT 1000",
          "format": 1
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Дата, время"
          }
        ]
      }
    },
    {
      "id": 6,
      "title": "Exception Timeline by Metadata Type",
      "type": "heatmap",
      "gridPos": {"h": 10, "w": 24, "x": 0, "y": 42},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "refId": "A",
          "queryType": "sql",
          "rawSql": "WITH metadata_errors AS (\n  SELECT\n    toDateTime(intDiv(toUInt32(timestamp), 3600) * 3600) AS time,\n    metadata_name,\n    infobase_guid,\n    CASE\n      WHEN match(metadata_name, '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}')\n      THEN reinterpretAsUUID(unhex(replaceAll(extractAll(metadata_name, '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}')[1], '-', '')))\n      ELSE toUUID('00000000-0000-0000-0000-000000000000')\n    END AS metadata_guid\n  FROM logs.tech_log\n  WHERE $__timeFilter(timestamp)\n    AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n    AND name IN ('EXCP', 'ERR', 'EXCPTXT')\n    AND metadata_name != ''\n)\nSELECT\n  me.time,\n  COALESCE(mm.metadata_type, 'Unknown') AS metadata_type,\n  count() AS count\nFROM metadata_errors me\nLEFT JOIN (\n  SELECT infobase_guid, metadata_guid, argMax(metadata_type, version) AS metadata_type\n  FROM logs.metadata_map\n  GROUP BY infobase_guid, metadata_guid\n) mm ON me.infobase_guid = mm.infobase_guid AND me.metadata_guid = mm.metadata_guid AND me.metadata_guid != toUUID('00000000-0000-0000-0000-000000000000')\nGROUP BY me.time, metadata_type\nORDER BY me.time",
          "format": 0
        }
      ],
      "options": {
        "calculate": false,
        "cellGap": 2,
        "color": {
          "mode": "spectrum",
          "scheme": "Reds"
        },
        "yAxis": {
          "axisPlacement": "left"
        }
      }
    },
    {
      "id": 7,
      "title": "Performance Events (Duration > 1s)",
      "type": "table",
      "gridPos": {"h": 10, "w": 24, "x": 0, "y": 52},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  timestamp AS \"Дата, время\",\n  infobase_name AS \"Информационная база\",\n  name AS \"Событие\",\n  duration_microseconds / 1000000.0 AS \"Длительность (сек)\",\n  metadata_name AS \"Метаданные\",\n  context AS \"Контекст\",\n  server_computer_name AS \"Сервер\"\nFROM logs.tech_log\nWHERE $__timeFilter(timestamp)\n  AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n  AND duration_microseconds > 1000000  -- More than 1 second\nORDER BY duration_microseconds DESC\nLIMIT 500",
          "format": 1
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Длительность (сек)"
          }
        ]
      },
      "fieldConfig": {
        "overrides": [
          {
            "matcher": {"id": "byName", "options": "Длительность (сек)"},
            "properties": [
              {
                "id": "custom.width",
                "value": 150
              },
              {
                "id": "color",
                "value": {
                  "mode": "thresholds"
                }
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "green"},
                    {"value": 5, "color": "yellow"},
                    {"value": 10, "color": "red"}
                  ]
                }
              }
            ]
          }
        ]
      }
    }
  ]
}
