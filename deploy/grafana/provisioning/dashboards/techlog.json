{
  "title": "1C Tech Log",
  "uid": "1c-tech-log",
  "version": 1,
  "schemaVersion": 38,
  "tags": ["1c", "tech-log"],
  "timezone": "browser",
  "time": {
    "from": "now-7d",
    "to": "now"
  },
  "refresh": "1m",
  "templating": {
    "list": [
      {
        "name": "event_name",
        "type": "query",
        "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
        "query": "SELECT DISTINCT name FROM logs.tech_log WHERE name != '' ORDER BY name",
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "includeAll": true,
        "multi": true,
        "allValue": null
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "title": "Duration Timeline (DBMSSQL, SDBL, PROC)",
      "type": "timeseries",
      "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  toDateTime(intDiv(toUInt32(ts), 300) * 300) AS time,\n  name,\n  avg(duration) / 1000000 AS avg_duration_ms,\n  quantile(0.95)(duration) / 1000000 AS p95_duration_ms,\n  max(duration) / 1000000 AS max_duration_ms\nFROM logs.tech_log\nWHERE $__timeFilter(ts)\n  AND name IN ('DBMSSQL', 'SDBL', 'PROC')\n  AND duration > 0\n  AND ($event_name = '$__all' OR name IN ($event_name))\nGROUP BY time, name\nORDER BY time",
          "refId": "A",
          "queryType": "sql",
          "format": 0
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth"
          }
        }
      }
    },
    {
      "id": 2,
      "title": "Locks Timeline (TLOCK, TTIMEOUT, TDEADLOCK)",
      "type": "timeseries",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  toDateTime(intDiv(toUInt32(ts), 300) * 300) AS time,\n  name,\n  count() AS count\nFROM logs.tech_log\nWHERE $__timeFilter(ts)\n  AND name IN ('TLOCK', 'TTIMEOUT', 'TDEADLOCK')\n  AND ($event_name = '$__all' OR name IN ($event_name))\nGROUP BY time, name\nORDER BY time",
          "refId": "A",
          "queryType": "sql",
          "format": 0
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 80
          },
          "color": {
            "mode": "palette-classic"
          }
        }
      }
    },
    {
      "id": 3,
      "title": "DBMSSQL Queries (Top by Duration)",
      "type": "table",
      "gridPos": {"h": 12, "w": 12, "x": 12, "y": 8},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  ts AS \"Время\",\n  duration / 1000000 AS \"Длительность (мс)\",\n  arrayElement(property_value, indexOf(property_key, 'Sql')) AS \"SQL запрос\",\n  usr AS \"Пользователь\",\n  session_id AS \"Сеанс\"\nFROM logs.tech_log\nWHERE $__timeFilter(ts)\n  AND name = 'DBMSSQL'\n  AND duration > 0\n  AND ($event_name = '$__all' OR name IN ($event_name))\nORDER BY duration DESC\nLIMIT 100",
          "refId": "A",
          "queryType": "sql",
          "format": 1
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Длительность (мс)"
          }
        ]
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto"
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Длительность (мс)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "custom.width",
                "value": 120
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "SQL запрос"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 400
              }
            ]
          }
        ]
      }
    },
    {
      "id": 4,
      "title": "Locks Details (TLOCK, TTIMEOUT, TDEADLOCK)",
      "type": "table",
      "gridPos": {"h": 12, "w": 12, "x": 0, "y": 16},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  ts AS \"Время\",\n  name AS \"Тип блокировки\",\n  arrayElement(property_value, indexOf(property_key, 'Txt')) AS \"Описание\",\n  arrayElement(property_value, indexOf(property_key, 'Descr')) AS \"Детали\",\n  usr AS \"Пользователь\",\n  session_id AS \"Сеанс\",\n  transaction_id AS \"Транзакция\"\nFROM logs.tech_log\nWHERE $__timeFilter(ts)\n  AND name IN ('TLOCK', 'TTIMEOUT', 'TDEADLOCK')\n  AND ($event_name = '$__all' OR name IN ($event_name))\nORDER BY ts DESC\nLIMIT 100",
          "refId": "A",
          "queryType": "sql",
          "format": 1
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Время"
          }
        ]
      }
    },
    {
      "id": 5,
      "title": "Errors Timeline",
      "type": "timeseries",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  toDateTime(intDiv(toUInt32(ts), 300) * 300) AS time,\n  name,\n  count() AS count\nFROM logs.tech_log\nWHERE $__timeFilter(ts)\n  AND level IN ('ERROR', 'EXCP')\n  AND ($event_name = '$__all' OR name IN ($event_name))\nGROUP BY time, name\nORDER BY time",
          "refId": "A",
          "queryType": "sql",
          "format": 0
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 80
          },
          "color": {
            "mode": "palette-classic"
          }
        }
      }
    },
    {
      "id": 6,
      "title": "Tech Log Events Distribution",
      "type": "piechart",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 28},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  name AS event,\n  count() AS count\nFROM logs.tech_log\nWHERE $__timeFilter(ts)\n  AND ($event_name = '$__all' OR name IN ($event_name))\nGROUP BY event\nORDER BY count DESC\nLIMIT 15",
          "refId": "A",
          "queryType": "sql",
          "format": 1
        }
      ],
      "options": {
        "pieType": "pie",
        "tooltip": {
          "mode": "single"
        },
        "legend": {
          "displayMode": "table",
          "placement": "right"
        }
      }
    }
  ]
}

