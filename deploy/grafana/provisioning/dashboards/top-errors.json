{
  "title": "1C Event Log - Top Errors",
  "uid": "1c-top-errors",
  "version": 1,
  "schemaVersion": 38,
  "tags": ["1c", "event-log", "errors"],
  "timezone": "browser",
  "time": {
    "from": "now-7d",
    "to": "now"
  },
  "refresh": "1m",
  "templating": {
    "list": [
      {
        "name": "infobase",
        "type": "query",
        "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
        "query": "SELECT DISTINCT infobase_name FROM logs.event_log WHERE infobase_name != '' AND level IN ('Error', 'Warning') ORDER BY infobase_name",
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "includeAll": true,
        "multi": true,
        "allValue": null
      },
      {
        "name": "user",
        "type": "query",
        "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
        "query": "SELECT DISTINCT user_name FROM logs.event_log WHERE user_name != '' AND level IN ('Error', 'Warning') ORDER BY user_name",
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "includeAll": true,
        "multi": true,
        "allValue": null
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "title": "Top Errors Table",
      "type": "table",
      "gridPos": {"h": 16, "w": 24, "x": 0, "y": 0},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  event_presentation AS \"Событие\",\n  user_name AS \"Пользователь\",\n  computer AS \"Компьютер\",\n  metadata_presentation AS \"Метаданные\",\n  comment AS \"Комментарий\",\n  count() AS \"Количество повторений\",\n  max(event_time) AS \"Последнее появление\"\nFROM logs.event_log\nWHERE $__timeFilter(event_time)\n  AND level IN ('Error', 'Warning')\n  AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n  AND ('$__all' IN ($user) OR user_name IN ($user))\nGROUP BY\n  event_presentation,\n  user_name,\n  computer,\n  metadata_presentation,\n  comment\nORDER BY \"Количество повторений\" DESC\nLIMIT 100",
          "refId": "A",
          "queryType": "sql",
          "format": 1
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Количество повторений"
          }
        ]
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto"
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Количество повторений"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 150
              },
              {
                "id": "custom.align",
                "value": "center"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Последнее появление"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 180
              }
            ]
          }
        ]
      }
    },
    {
      "id": 2,
      "title": "Errors by Event Type",
      "type": "barchart",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  event_presentation AS event,\n  count() AS count\nFROM logs.event_log\nWHERE $__timeFilter(event_time)\n  AND level IN ('Error', 'Warning')\n  AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n  AND ('$__all' IN ($user) OR user_name IN ($user))\nGROUP BY event\nORDER BY count DESC\nLIMIT 10",
          "refId": "A",
          "queryType": "sql",
          "format": 1
        }
      ],
      "options": {
        "orientation": "horizontal",
        "legend": {
          "displayMode": "table",
          "placement": "right"
        }
      }
    },
    {
      "id": 3,
      "title": "Errors by User",
      "type": "barchart",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
      "targets": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "clickhouse"},
          "rawSql": "SELECT\n  user_name AS user,\n  count() AS count\nFROM logs.event_log\nWHERE $__timeFilter(event_time)\n  AND level IN ('Error', 'Warning')\n  AND ('$__all' IN ($infobase) OR infobase_name IN ($infobase))\n  AND ('$__all' IN ($user) OR user_name IN ($user))\n  AND user_name != ''\nGROUP BY user\nORDER BY count DESC\nLIMIT 10",
          "refId": "A",
          "queryType": "sql",
          "format": 1
        }
      ],
      "options": {
        "orientation": "horizontal",
        "legend": {
          "displayMode": "table",
          "placement": "right"
        }
      }
    }
  ]
}

