version: '3.8'

services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: 1c-log-clickhouse
    ports:
      - "8123:8123"  # HTTP
      - "9000:9000"  # Native
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ../clickhouse/init:/docker-entrypoint-initdb.d:ro
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-logs}
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 0
    networks:
      - internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  log-parser:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.parser
    container_name: 1c-log-parser
    depends_on:
      clickhouse:
        condition: service_healthy
    volumes:
      - ${LOG_DIRS:-C:\Program Files\1cv8\srvinfo}:/mnt/logs:ro
      - ${TECHLOG_DIRS:-C:\ProgramData\1C\1Cv8\logs}:/mnt/techlog:ro
      - parser_offsets:/app/offsets
    environment:
      LOG_DIRS: ${LOG_DIRS:-/mnt/logs}
      TECHLOG_DIRS: ${TECHLOG_DIRS:-/mnt/techlog}
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT:-9000}
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-logs}
      LOG_RETENTION_DAYS: ${LOG_RETENTION_DAYS:-30}
      READ_ONLY: ${READ_ONLY:-false}
      OFFSET_MIRROR: ${OFFSET_MIRROR:-false}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - internal
    restart: unless-stopped

  mcp-server:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.mcp
    container_name: 1c-log-mcp
    depends_on:
      clickhouse:
        condition: service_healthy
    ports:
      - "${MCP_PORT:-8080}:8080"
    volumes:
      - ../../configs:/app/configs:ro
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT:-9000}
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-logs}
      MCP_PORT: ${MCP_PORT:-8080}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - internal
      - monitoring
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: 1c-log-grafana
    depends_on:
      clickhouse:
        condition: service_healthy
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ../grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: "Admin"
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: vertamedia-clickhouse-datasource
    networks:
      - monitoring
    restart: unless-stopped

volumes:
  clickhouse_data:
    driver: local
  grafana_data:
    driver: local
  parser_offsets:
    driver: local

networks:
  internal:
    driver: bridge
  monitoring:
    driver: bridge

